#!/bin/sh
# Clean temporary files for all sites
# This script cleans old temporary files from site-specific tmp directories

# Age in days for different file types
SESSION_AGE=7      # PHP session files
UPLOAD_AGE=1       # Uploaded files not processed
OPCACHE_AGE=30     # OPcache files
WSDL_AGE=7         # SOAP WSDL cache files
GENERAL_AGE=30     # ALL other files (except README.md)

# Function to clean a site's tmp directory
clean_site_tmp() {
    local site_dir="$1"
    local domain=$(basename "$site_dir")

    if [ ! -d "$site_dir/tmp" ]; then
        return
    fi

    echo "Cleaning tmp for $domain..."
    local count=0

    # Clean old PHP session files (sess_*)
    count=$(find "$site_dir/tmp" -maxdepth 1 -name "sess_*" -type f -mtime +$SESSION_AGE -delete -print 2>/dev/null | wc -l)
    [ "$count" -gt 0 ] && echo "  Removed $count old session files"

    # Clean old PHP upload temp files (php followed by 6 chars)
    count=$(find "$site_dir/tmp" -maxdepth 1 -regex ".*/php[A-Za-z0-9]\{6\}$" -type f -mtime +$UPLOAD_AGE -delete -print 2>/dev/null | wc -l)
    [ "$count" -gt 0 ] && echo "  Removed $count old PHP upload files"

    # Clean old OPcache files
    if [ -d "$site_dir/tmp/opcache" ]; then
        count=$(find "$site_dir/tmp/opcache" -type f -mtime +$OPCACHE_AGE -delete -print 2>/dev/null | wc -l)
        [ "$count" -gt 0 ] && echo "  Removed $count old OPcache files"
    fi

    # Clean old SOAP WSDL cache files
    count=$(find "$site_dir/tmp" -maxdepth 1 -name "wsdl-*" -type f -mtime +$WSDL_AGE -delete -print 2>/dev/null | wc -l)
    [ "$count" -gt 0 ] && echo "  Removed $count old WSDL cache files"

    # Clean ALL other files older than 30 days (except README.md)
    count=$(find "$site_dir/tmp" -type f -mtime +$GENERAL_AGE -not -name "README.md" -not -name "sess_*" -not -regex ".*/php[A-Za-z0-9]\{6\}$" -not -name "wsdl-*" -delete -print 2>/dev/null | wc -l)
    [ "$count" -gt 0 ] && echo "  Removed $count old files (30+ days)"

    # Clean ALL empty directories (except opcache root)
    count=$(find "$site_dir/tmp" -mindepth 1 -type d -empty -not -path "*/opcache" -delete -print 2>/dev/null | wc -l)
    [ "$count" -gt 0 ] && echo "  Removed $count empty directories"
}

# Main execution
if [ "$1" = "--help" ] || [ "$1" = "-h" ]; then
    cat << EOF
Site temporary files cleanup script

Usage: $(basename $0) [OPTIONS]

Options:
    --dry-run    Show what would be deleted without actually deleting
    --verbose    Show detailed output
    --help       Show this help message

This script cleans:
    - PHP session files older than $SESSION_AGE days
    - PHP upload temp files older than $UPLOAD_AGE day
    - OPcache files older than $OPCACHE_AGE days
    - WSDL cache files older than $WSDL_AGE days
    - ALL other files older than $GENERAL_AGE days (except README.md)
    - Empty directories (except opcache/)

EOF
    exit 0
fi

# Check if running as root
if [ "$(id -u)" != "0" ]; then
    echo "Error: This script must be run as root" >&2
    exit 1
fi

# Process all sites
for site_dir in /sites/*/; do
    [ -d "$site_dir" ] || continue
    clean_site_tmp "$site_dir"
done

echo "Cleanup completed."